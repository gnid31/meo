<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hihi concho Hằng</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #FFC0CB;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 40px 20px;
      box-sizing: border-box;
      overflow: hidden;
      transition: background-image 1s ease-in-out;
    }

    .container {
      background-color: rgba(255, 255, 255, 0.7);
      padding: 30px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 500px;
      width: 100%;
      position: relative;
      z-index: 10;
    }

    h1 {
      color: #FF69B4;
      margin-bottom: 25px;
      font-size: 2.5em;
      font-weight: bold;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      animation: wave 2s ease-in-out infinite alternate;
    }

    audio {
      display: none;
    }

    p {
      font-size: 1.2em;
      line-height: 1.7;
      color: #FF1493;
      margin-top: 20px;
      font-style: italic;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
    }

    .snowflake {
      color: #fff;
      font-size: 1.2em;
      position: fixed;
      top: -10px;
      opacity: 0.7;
      user-select: none;
      pointer-events: none;
    }

    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #FFC0CB;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      text-align: center;
      transition: opacity 0.5s ease-out;
    }

    #splash-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    #mystery-text {
      font-size: 3.5em;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
      margin-bottom: 30px;
      animation: bounce 1s infinite alternate;
    }

    @keyframes bounce {
      0% {
        transform: translateY(0);
      }

      100% {
        transform: translateY(-10px);
      }
    }

    #exit-hint {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: #fff;
      font-size: 1.5em;
      font-weight: bold;
      text-shadow: 1px 1px 3px black;
      z-index: 100001;
      animation: gentleShake 2s infinite ease-in-out;
    }


    #gift-box {
      width: 150px;
      height: 150px;
      margin-bottom: 40px;
      position: relative;
    }

    #claim-button {
      background-color: #FF1493;
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      font-size: 2em;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, scale 0.2s ease-in-out;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }

    #claim-button:hover {
      background-color: #e60073;
      transform: translateY(-2px);
      scale: 1.05;
    }

    #question-box {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border: 3px solid #FF69B4;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      z-index: 10000;
      transform-origin: center;
    }

    #error-message {
      color: red;
      margin-top: 10px;
      font-weight: bold;
    }

    #attempts-left {
      color: red;
      margin-top: 5px;
    }

    #locked-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10001;
      color: #fff;
      font-size: 2em;
      text-align: center;
      padding: 20px;
      transition: opacity 0.3s ease-in-out;
    }

    #locked-screen .highlight-text {
      font-size: 3em;
      font-weight: bold;
      color: #FFD700;
      text-shadow: 0 0 15px #ff69b4, 0 0 25px #ff1493, 2px 2px 10px rgba(0, 0, 0, 0.7);
      animation: glowText 1.5s ease-in-out infinite alternate;
    }

    #song-buttons {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #song-buttons button {
      background-color: #FF69B4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      margin: 5px;
      font-size: 1em;
      cursor: pointer;
      transition: transform 0.2s ease;
      width: 120px;
    }

    #song-buttons button:hover {
      background-color: #e60073;
      transform: scale(1.05);
    }


    @keyframes glowText {
      from {
        text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff1493;
        transform: scale(1);
      }

      to {
        text-shadow: 0 0 20px #ff69b4, 0 0 30px #ff1493;
        transform: scale(1.05);
      }
    }

    @keyframes gentleShake {
      0% {
        transform: translateX(0);
      }

      25% {
        transform: translateX(-2px);
      }

      50% {
        transform: translateX(2px);
      }

      75% {
        transform: translateX(-1px);
      }

      100% {
        transform: translateX(0);
      }
    }

    #locked-screen .f5-hint {
      animation: gentleShake 1s infinite ease-in-out;
      font-size: 0.8em;
      margin-top: 20px;
      color: #fff;
      opacity: 0.9;
    }

    #screensaver {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      z-index: 100000;
      display: none;
      overflow: hidden;
    }

    #screensaver img {
      position: absolute;
      width: 200px;
      height: 200px;
      object-fit: contain;
      pointer-events: none;
    }


    @media (max-width: 600px) {
      .container {
        padding: 25px 30px;
      }

      h1 {
        font-size: 2em;
      }

      p {
        font-size: 1.1em;
      }

      #mystery-text {
        font-size: 2.5em;
      }

      #gift-box {
        width: 120px;
        height: 120px;
      }

      #claim-button {
        font-size: 1.5em;
        padding: 12px 30px;
      }
    }

    @keyframes shake {

      0%,
      100% {
        transform: translate(-50%, -50%);
      }

      10%,
      30%,
      50%,
      70%,
      90% {
        transform: translate(calc(-50% - 5px), calc(-50% - 2px));
      }

      20%,
      40%,
      60%,
      80% {
        transform: translate(calc(-50% + 5px), calc(-50% + 2px));
      }
    }

    .shake {
      animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
    }

    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10002;
      justify-content: center;
      align-items: center;
    }

    .popup-content {
      background-color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: popupAppear 0.5s ease-out;
      border: 3px solid #FF69B4;
      box-shadow: 0 0 20px rgba(255, 105, 180, 0.5);
    }

    .popup-content h2 {
      color: #FF1493;
      margin-bottom: 20px;
      font-size: 2em;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    #close-popup {
      background-color: #FF69B4;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 1.2em;
      cursor: pointer;
      margin-top: 20px;
      transition: all 0.3s ease;
    }

    #close-popup:hover {
      background-color: #FF1493;
      transform: scale(1.05);
    }

    @keyframes popupAppear {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* New CSS for the GIF overlay */
    #error-gif-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgb(255, 255, 255); /* Đã thay đổi từ rgba(255, 255, 255, 0.9) thành màu trắng hoàn toàn */
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10003; /* Above question box */
      pointer-events: none; /* Allow clicks to pass through if needed */
      opacity: 0; /* Initially hidden */
      transition: opacity 0.3s ease-in-out;
    }

    #error-gif-overlay.visible {
      opacity: 1;
    }

    #error-gif {
      width: 80%; /* Adjust size as needed */
      height: auto;
      max-width: 250px; /* Max width for larger screens */
    }

    /* New styles for submit-answer button */
    #submit-answer {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: #FF69B4;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.3s ease; /* Thêm hiệu ứng chuyển đổi mượt mà */
    }

    #submit-answer:hover:not(:disabled) {
      background-color: #e60073; /* Màu tối hơn khi hover */
      transform: scale(1.05); /* Phồng ra một chút */
    }

    #submit-answer:disabled {
      background-color: #cccccc; /* Màu xám khi bị vô hiệu hóa */
      cursor: not-allowed;
    }

    /* New CSS for success screensaver */
    #success-screensaver {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #FFC0CB; /* Màu hồng phấn */
      display: none; /* Hidden by default */
      overflow: hidden;
      z-index: 9999;
    }

    #success-screensaver .firework-gif {
      position: absolute;
      width: 150px; /* Kích thước cơ bản của GIF pháo hoa */
      height: auto;
      opacity: 0;
      animation: fadeAndMove 6s ease-out forwards; /* Hoạt ảnh fade out và di chuyển */
      pointer-events: none;
    }

    /* New styles for success exit hint */
    #success-exit-hint {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      color: #fff;
      font-size: 2em;
      font-weight: bold;
      text-shadow: 1px 1px 3px black;
      z-index: 100001;
      animation: gentleShake 2s infinite ease-in-out; /* Áp dụng animation gentleShake */
    }

    @keyframes fadeAndMove {
      0% {
        opacity: 0;
        transform: translateY(0) scale(0.5);
      }
      20% {
        opacity: 1;
        transform: translateY(-20px) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-100px) scale(0.8);
      }
    }
  </style>
</head>

<body>
  <div id="splash-screen">
    <div id="mystery-text">Mystery Box</div>
    <img id="gift-box"
      src="https://raw.githubusercontent.com/gnid31/meo/refs/heads/main/gif/box.gif"
      alt="Gift Box">
    <button id="claim-button">Unbox</button>
  </div>

  <div id="question-box">
    <div><strong>Câu hỏi bí mật:</strong> Chuỗi đổi màu lúc bao nhiu tủi???</div>
    <input type="text" id="secret-answer" placeholder="Nhập câu trả lời..."
      style="padding: 10px; font-size: 1em; margin-top: 15px; width: 80%;">
    <button id="submit-answer">Trả lời</button>
    <div id="error-message"></div>
    <div id="attempts-left"></div>
    <!-- New GIF overlay -->
    <div id="error-gif-overlay">
      <img id="error-gif" src="https://raw.githubusercontent.com/gnid31/meo/refs/heads/main/gif/bite.gif" alt="Error GIF">
    </div>
  </div>

  <div id="locked-screen">
    <div class="highlight-text">
      <div>đáng đánh!!!</div>
    </div>
    <!-- New GIF for locked screen -->
    <img id="fight-gif" src="https://raw.githubusercontent.com/gnid31/meo/refs/heads/main/gif/fight3.gif" alt="Fight GIF" style="width: 500px; height: auto; margin-top: 30px;">
    <div class="f5-hint">Press F5 to continue opening the Mystery Box</div>
  </div>

  <div class="container">
    <h1>Meo meo đi này!</h1>
    <div id="song-selector">
      <p>🎵 Âm nhạc là music</p>
      <div id="song-buttons">
        <button onclick="playSong(0)">Bài 8</button>
        <button onclick="playSong(1)">Bài 20</button>
        <button onclick="playSong(2)">Bài 7</button>
        <button onclick="playSong(3)">Bài 0</button>
        <button onclick="playSong(4)">Bài 13</button>
        <button onclick="playSong(5)">Bài 6</button>
      </div>
    </div>

    <audio id="myAudio" controls>
      <source id="audio-source" src="" type="audio/mpeg">
      Trình duyệt không hỗ trợ audio.
    </audio>

    <p></p>
  </div>

  <audio id="error-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

  <!-- New audio for fireworks background music -->
  <audio id="fireworks-music" src="https://github.com/gnid31/meo/raw/main/music/happy_birthday.mp3" loop></audio>

  <!-- New success screensaver HTML -->
  <div id="success-screensaver">
    <div id="success-exit-hint">Press any key to exit</div>
  </div>

  <script>
    console.log("Script loaded and starting execution.");

    // const BACKGROUND_IMAGE_URL = "C:/Users/ADMIN/Desktop/meomeo/wallpaper/e82e59a091fccfe88d581ef7dc56f070.jpg";
    let wallpaperImageUrls = []; // New global array for wallpaper image URLs
    let currentBackgroundIndex = 0;
    let backgroundChangeInterval = null; // Biến để lưu trữ interval thay đổi ảnh nền
    let attemptsLeft = 4;
    let fireworkInterval = null;
    let animationInterval = null; // Cần là global để showScreensaver có thể clear nó
    let allowExitSuccessScreen = false; // Khai báo biến cờ mới
    let activeFireworkElements = []; // Global array to store active firework elements and their positions

    // Khai báo các biến DOM element ở phạm vi toàn cục
    let screensaver;
    let bouncingImg;
    let splashScreen;
    let claimButton;
    let audio;
    let body;
    let questionBox;
    let answerInput;
    let submitBtn;
    let errorMessage;
    let attemptsMessage;
    let lockedScreen;
    let errorSound;
    let errorGifOverlay;
    let successScreensaver;
    let fireworksMusic; // Declare new variable for fireworks music

    const baseGifDuration = 1580; // Thời gian cơ bản cho GIF (miligiây)

    // Helper to check for overlap between two rectangles
    function checkOverlap(rect1, rect2) {
        return rect1.x < rect2.x + rect2.width &&
               rect1.x + rect1.width > rect2.x &&
               rect1.y < rect2.y + rect2.height &&
               rect1.y + rect1.height > rect2.y;
    }

    // Function to find a non-overlapping position
    function findNonOverlappingPosition(gifWidth, gifHeight, maxAttempts = 50) {
        let newX, newY;
        let newRect;
        let foundPosition = false;

        for (let i = 0; i < maxAttempts; i++) {
            newX = Math.random() * (window.innerWidth - gifWidth);
            newY = Math.random() * (window.innerHeight - gifHeight);
            newRect = { x: newX, y: newY, width: gifWidth, height: gifHeight };

            let overlaps = false;
            for (const activeFirework of activeFireworkElements) {
                if (activeFirework.gifElement.isConnected && checkOverlap(newRect, activeFirework.rect)) { // check if element is still in DOM
                    overlaps = true;
                    break;
                }
            }

            if (!overlaps) {
                foundPosition = true;
                break;
            }
        }

        if (foundPosition) {
            return { x: newX, y: newY };
        } else {
            // If a non-overlapping position cannot be found after maxAttempts,
            // just return a random position and accept potential overlap.
            console.warn('Could not find a non-overlapping position for firework after multiple attempts. Placing randomly.');
            return {
                x: Math.random() * (window.innerWidth - gifWidth),
                y: Math.random() * (window.innerHeight - gifHeight)
            };
        }
    }

    function createSnowflake() {
      if (document.querySelectorAll('.snowflake').length > 100) return;
      const snowflake = document.createElement('div');
      snowflake.classList.add('snowflake');
      snowflake.innerHTML = '❄';
      document.body.appendChild(snowflake);
      const startPosition = Math.random() * window.innerWidth;
      const endPosition = window.innerHeight + 20;
      const fallDuration = Math.random() * 5 + 5;
      const startScale = (Math.random() * 0.5 + 0.5) * 1.5;
      const endScale = startScale * 0.3;
      const horizontalDrift = Math.random() * 50 - 25;
      snowflake.style.left = `${startPosition}px`;
      snowflake.style.fontSize = `${startScale}em`;
      snowflake.style.opacity = Math.random() * 0.5 + 0.5;
      const animation = snowflake.animate([
        {
          transform: `translateY(0) translateX(0) scale(${startScale})`,
          opacity: snowflake.style.opacity
        },
        {
          transform: `translateY(${endPosition}px) translateX(${horizontalDrift}px) scale(${endScale})`,
          opacity: 0
        }
      ], {
        duration: fallDuration * 1000,
        easing: 'linear',
        iterations: 1
      });
      animation.onfinish = () => {
        snowflake.remove();
      };
    }

    function startSnowfall(flakeInterval = 133) {
      setInterval(createSnowflake, flakeInterval);
    }

    const songList = [
      "https://github.com/gnid31/meo/raw/main/music/id_072019.mp3",
      "https://github.com/gnid31/meo/raw/main/music/uoc_gi.mp3",
      "https://github.com/gnid31/meo/raw/main/music/hen_mot_mai.mp3",
      "https://github.com/gnid31/meo/raw/main/music/am_tham_ben_em.mp3",
      "https://github.com/gnid31/meo/raw/main/music/neu_ngay_ay.mp3",
      "https://github.com/gnid31/meo/raw/main/music/gia_nhu_em_nhin_lai.mp3",
    ];

    function playSong(index) {
      const songUrl = songList[index];
      showScreensaver(songUrl);
    }

    document.addEventListener('DOMContentLoaded', async () => {

      // Gán các biến DOM element ở đây
      screensaver = document.getElementById("screensaver");
      bouncingImg = document.getElementById("bouncing-image");
      splashScreen = document.getElementById('splash-screen');
      claimButton = document.getElementById('claim-button');
      audio = document.getElementById('myAudio');
      body = document.body;
      questionBox = document.getElementById('question-box');
      answerInput = document.getElementById('secret-answer');
      submitBtn = document.getElementById('submit-answer');
      errorMessage = document.getElementById('error-message');
      attemptsMessage = document.getElementById('attempts-left');
      lockedScreen = document.getElementById('locked-screen');
      errorSound = document.getElementById('error-sound');
      errorGifOverlay = document.getElementById('error-gif-overlay');
      successScreensaver = document.getElementById('success-screensaver'); // Get the new success screensaver
      fireworksMusic = document.getElementById('fireworks-music'); // Get the new fireworks music element

      function handleAnswerSubmission() {
        const correctAnswer = '107';
        if (answerInput.value.trim() === correctAnswer) {
          questionBox.style.display = 'none';
          // Hide splash screen if it's still visible
          splashScreen.classList.add('hidden');

          // Show success screensaver
          successScreensaver.style.display = 'block';
          allowExitSuccessScreen = false; // Vô hiệu hóa thoát ngay lập tức

          // Kích hoạt pháo hoa và nhạc sau một khoảng thời gian ngắn
          setTimeout(() => {
            startFireworksEffect(); // Bắt đầu hiệu ứng GIF
            if (fireworksMusic) { // Phát nhạc pháo hoa
              console.log('Attempting to load and play fireworks music...');
              fireworksMusic.load(); // Tải âm thanh
              fireworksMusic.play().then(() => {
                console.log('Fireworks music started playing successfully.');
                // Đặt cờ cho phép thoát sau khi nhạc đã được cố gắng phát thành công
                // Chúng ta sẽ đặt cờ này với một độ trễ riêng biệt để tránh xung đột
              }).catch(error => {
                if (error.name === 'NotAllowedError') {
                  console.error('Autoplay prevented for fireworks music. User interaction needed.');
                } else if (error.name === 'AbortError') {
                  console.warn('Fireworks music play aborted. This often happens if play() is called, and then pause() or another play() is called rapidly afterwards.');
                } else {
                  console.error('Error playing fireworks music:', error);
                }
                // Nếu có lỗi, vẫn cho phép thoát sau một chút trễ để người dùng không bị kẹt
              });
            }
            startSnowfall(); // Đã bỏ comment để kích hoạt tuyết rơi
          }, 1000); // Độ trễ 1s để tuyết rơi bắt đầu sau khi pháo hoa/nhạc đã được xử lý một chút

          // THÊM ĐOẠN MÃ NÀY: Đặt cờ cho phép thoát màn hình thành công sau một khoảng trễ riêng biệt
          setTimeout(() => {
            allowExitSuccessScreen = true;
          }, 700); // 500ms ban đầu + 200ms để nhạc có thời gian khởi tạo

          // Bắt đầu thay đổi ảnh nền khi màn hình pháo hoa kết thúc hoặc bị thoát
        } else {
          attemptsLeft--;
          answerInput.disabled = true;
          submitBtn.disabled = true;

          questionBox.classList.add('shake');

          if (attemptsLeft > 0) {
            // Buộc GIF tải lại từ đầu
            errorGifOverlay.querySelector('#error-gif').src = '';
            errorGifOverlay.querySelector('#error-gif').src = 'https://raw.githubusercontent.com/gnid31/meo/refs/heads/main/gif/bite.gif';

            errorGifOverlay.classList.add('visible'); // Hiển thị GIF

            const currentGifDuration = baseGifDuration * (4 - attemptsLeft); // Tính toán thời gian dựa trên số lần sai
            setTimeout(() => {
              errorGifOverlay.classList.remove('visible'); // Ẩn GIF sau thời gian tính toán
              answerInput.disabled = false; // Kích hoạt lại ô nhập liệu
              answerInput.focus();          // Tập trung vào ô nhập liệu
            }, currentGifDuration);
          } else {
            // Nếu là lần cuối cùng (attemptsLeft = 0), không hiển thị GIF,
            // và các nút/ô nhập liệu sẽ không được kích hoạt lại vì hộp câu hỏi sẽ biến mất.
          }

          errorSound.play()
            .then(() => {
              errorSound.onended = () => {
                questionBox.classList.remove('shake');
              };
            })
            .catch(console.error);

          if (attemptsLeft <= 0) {
            questionBox.style.display = 'none';
            lockedScreen.style.display = 'flex';
          } else {
            errorMessage.textContent = 'Sai rồi, lêu lêu!';
            attemptsMessage.textContent = `Còn ${attemptsLeft} lần nhập thôi nha!`;
            answerInput.value = '';
          }
        }
      }

      if (claimButton && submitBtn && questionBox && answerInput) {
        claimButton.addEventListener('click', () => {
          questionBox.style.display = 'block';
          answerInput.focus();
          // Sau khi hiện question box, đảm bảo nút trả lời đúng trạng thái ban đầu (disabled nếu rỗng)
          if (answerInput.value.trim() === '') {
            submitBtn.disabled = true;
          }
        });

        submitBtn.addEventListener('click', handleAnswerSubmission);

        // Thêm sự kiện 'input' để kiểm tra ô nhập liệu và kích hoạt/vô hiệu hóa nút
        answerInput.addEventListener('input', () => {
          if (answerInput.value.trim() === '') {
            submitBtn.disabled = true; // Đảm bảo nút bị vô hiệu hóa khi input rỗng
          } else {
            submitBtn.disabled = false;
          }
        });


        answerInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            // Chỉ gọi handleAnswerSubmission nếu nút không bị disabled (tức là input không rỗng)
            if (!submitBtn.disabled) {
              handleAnswerSubmission();
            }
          }
        });


        window.addEventListener('keydown', (e) => {
          // Chỉ xử lý F5 để reset khi màn hình bị khóa đang hiển thị
          if (e.key === 'F5' && lockedScreen.style.display === 'flex') {
            e.preventDefault(); // Ngăn trang reload

            attemptsLeft = 4;
            errorMessage.textContent = '';
            attemptsMessage.textContent = '';
            answerInput.value = ''; // Xóa giá trị
            lockedScreen.style.display = 'none';
            questionBox.style.display = 'block';
            answerInput.disabled = false; // Kích hoạt lại ô nhập liệu
            answerInput.focus();
            // Kích hoạt lại nút trả lời sẽ được xử lý tự động khi value của input thay đổi (thành rỗng)
            answerInput.dispatchEvent(new Event('input')); // Kích hoạt sự kiện input để cập nhật trạng thái nút

            // Đảm bảo dừng và xóa pháo hoa khi reset hoàn toàn
            if (fireworkInterval) {
              clearInterval(fireworkInterval);
              fireworkInterval = null;
            }
            if (successScreensaver) {
              successScreensaver.style.display = 'none';
              if (fireworksMusic) { // Stop fireworks music
                fireworksMusic.pause();
                fireworksMusic.currentTime = 0;
              }
              allowExitSuccessScreen = false; // Đặt lại cờ
              activeFireworkElements = []; // Clear all active fireworks
            }

          } else if (successScreensaver && successScreensaver.style.display === 'block' && allowExitSuccessScreen) { // Thêm điều kiện cờ
            // Khi người dùng nhấn phím bất kỳ để thoát màn hình thành công
            successScreensaver.style.display = 'none';
            if (fireworkInterval) {
              clearInterval(fireworkInterval);
              fireworkInterval = null;
            }
            // Tùy chọn: Dừng nhạc hoặc reset screensaver chính ở đây nếu cần
            if (audio) {
              audio.pause();
              audio.currentTime = 0;
            }
            if (fireworksMusic) { // Stop fireworks music
              fireworksMusic.pause();
              fireworksMusic.currentTime = 0;
            }
          }
        });


      } else {
        console.error('Một hoặc nhiều phần tử không được tìm thấy trong DOM.');
      }
    });


    const bouncingImages = [];

    // Hàm để đọc danh sách ảnh từ URL và tải trước chúng
    async function loadImages() {
      try {
        console.log('Bắt đầu tải danh sách ảnh...');
        const response = await fetch('https://raw.githubusercontent.com/gnid31/meo/refs/heads/main/list.txt');
        console.log('Response status:', response.status);
        const text = await response.text();
        console.log('Text nhận được:', text);
        const imageUrls = text.split('\n').filter(url => url.trim() !== '');
        console.log('Số lượng ảnh tìm thấy:', imageUrls.length);

        const promises = imageUrls.map(url => {
          return new Promise((resolve, reject) => {
            const img = new Image();
            img.src = url;
            img.onload = () => {
              bouncingImages.push(img); // Lưu trữ đối tượng Image đã tải
              resolve();
            };
            img.onerror = () => {
              console.error(`Failed to load image: ${url}`);
              reject();
            };
          });
        });

        await Promise.allSettled(promises); // Chờ tất cả ảnh được tải (hoặc thất bại)
        console.log('Hoàn thành tải ảnh, số lượng ảnh sẵn sàng:', bouncingImages.length);
      } catch (error) {
        console.error('Error loading images:', error);
      }
    }

    // New function for fireworks effect
    function startFireworksEffect() {
      if (bouncingImages.length === 0) {
        console.error('No images loaded for fireworks effect.');
        return;
      }
      if (fireworkInterval) {
        clearInterval(fireworkInterval); // Clear any existing interval
      }

      // No clearing interval here as per user's last request (keep spawning)

      // Clear existing interval if any to avoid duplicates
      if (fireworkInterval) {
          clearInterval(fireworkInterval);
      }

      fireworkInterval = setInterval(() => {
        const gif = document.createElement('img');
        gif.classList.add('firework-gif');
        const randomIndex = Math.floor(Math.random() * bouncingImages.length);
        gif.src = bouncingImages[randomIndex].src;

        // Estimated dimensions for initial placement.
        // CSS defines width: 150px, height: auto. We'll use 150x150 as a reasonable estimate.
        const estimatedGifWidth = 150;
        const estimatedGifHeight = 150;

        // Find a non-overlapping position
        const position = findNonOverlappingPosition(estimatedGifWidth, estimatedGifHeight);

        gif.style.left = `${position.x}px`;
        gif.style.top = `${position.y}px`;

        successScreensaver.appendChild(gif);

        // Add to active list
        const fireworkEntry = {
            gifElement: gif,
            rect: { x: position.x, y: position.y, width: estimatedGifWidth, height: estimatedGifHeight }
        };
        activeFireworkElements.push(fireworkEntry);

        // Update exact dimensions once loaded
        gif.onload = () => {
            fireworkEntry.rect.width = gif.offsetWidth;
            fireworkEntry.rect.height = gif.offsetHeight;
        };

        // Remove gif and its position entry after its animation duration
        const animationDurationMs = 6 * 1000; // Match CSS animation duration (6s)
        setTimeout(() => {
            gif.remove();
            // Remove from activeFireworkElements array
            const index = activeFireworkElements.indexOf(fireworkEntry);
            if (index > -1) {
                activeFireworkElements.splice(index, 1);
            }
        }, animationDurationMs);

      }, 600); // Create GIF every 600ms
    }

    // New function to clear all fireworks GIFs (vẫn giữ để dùng khi cần reset hoàn toàn)
    function clearFireworks() {
      if (successScreensaver) {
        while (successScreensaver.querySelector('.firework-gif')) {
          successScreensaver.querySelector('.firework-gif').remove();
        }
      }
    }


    // Gọi hàm loadImages khi trang được tải
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM đã được tải, bắt đầu tải ảnh...');
      await loadImages(); // For fireworks
      await loadWallpaperImages(); // Load wallpaper images
      console.log('Hoàn thành tải ảnh');
      // Ban đầu vô hiệu hóa nút submit nếu input rỗng
      if (answerInput.value.trim() === '') {
        submitBtn.disabled = true;
      }
      // Khởi động thay đổi ảnh nền ngay khi DOM tải xong
      startBackgroundChange();
    });

    let currentImgIndex = 0;

    function showScreensaver(songUrl) {
      if (bouncingImages.length === 0) {
        console.error('No images loaded');
        return;
      }
      const screensaver = document.getElementById("screensaver");
      const bouncingImg = document.getElementById("bouncing-image");
      const audio = document.getElementById("myAudio");
      const source = document.getElementById("audio-source");

      if (animationInterval) {
        clearInterval(animationInterval);
      }

      screensaver.style.display = "flex";

      const randomIndex = Math.floor(Math.random() * bouncingImages.length);
      currentImgIndex = randomIndex;

      // Loại bỏ các dòng ẩn/hiện ảnh
      // bouncingImg.style.visibility = 'hidden';
      bouncingImg.src = bouncingImages[randomIndex].src;
      // setTimeout(() => {
      //     bouncingImg.style.visibility = 'visible';
      // }, 0);


      // Xử lý audio an toàn hơn
      try {
        audio.pause();
        audio.currentTime = 0;

        source.src = songUrl;
        audio.load();

        // Thêm một chút delay trước khi play
        setTimeout(() => {
          audio.play().catch(error => {
            if (error.name !== 'AbortError') {
              console.log('Audio play error:', error);
            }
          });
        }, 100);
      } catch (error) {
        console.log('Audio handling error:', error);
      }

      screensaver.style.display = "block";

      let dx = 3;
      let dy = 2;
      let x = 100;
      let y = 100;

      animationInterval = setInterval(() => {
        const imgWidth = bouncingImg.clientWidth;
        const imgHeight = bouncingImg.clientHeight;
        const maxX = window.innerWidth - imgWidth;
        const maxY = window.innerHeight - imgHeight;

        x += dx;
        y += dy;

        if (x <= 0 || x >= maxX) {
          dx *= -1;
          switchImageRandom();
        }

        if (y <= 0 || y >= maxY) {
          dy *= -1;
          switchImageRandom();
        }

        bouncingImg.style.left = `${x}px`;
        bouncingImg.style.top = `${y}px`;
      }, 16);

      audio.onended = function() {
        screensaver.style.display = "none";
        if (animationInterval) {
          clearInterval(animationInterval);
          animationInterval = null;
        }
      };
    }

    function switchImageRandom() {
      const bouncingImg = document.getElementById("bouncing-image");
      if (!bouncingImg) return;

      let newIndex;
      do {
        newIndex = Math.floor(Math.random() * bouncingImages.length);
      } while (newIndex === currentImgIndex && bouncingImages.length > 1);

      currentImgIndex = newIndex;
      // Loại bỏ các dòng ẩn/hiện ảnh
      // bouncingImg.style.visibility = 'hidden';
      bouncingImg.src = bouncingImages[currentImgIndex].src;
      // setTimeout(() => {
      //     bouncingImg.style.visibility = 'visible';
      // }, 0);
    }

    document.addEventListener('keydown', function handleAnyKeyExitScreensaver(e) {
      const screensaver = document.getElementById("screensaver");
      if (screensaver && screensaver.style.display === "block") {
        screensaver.style.display = "none";
        if (animationInterval) {
          clearInterval(animationInterval);
          animationInterval = null;
        }

        const audio = document.getElementById('myAudio');
        if (audio) {
          audio.pause();
          audio.currentTime = 0;
        }
      } else if (successScreensaver && successScreensaver.style.display === 'block' && allowExitSuccessScreen) { // Thêm điều kiện cờ
            successScreensaver.style.display = 'none';
            if (fireworkInterval) {
              clearInterval(fireworkInterval);
              fireworkInterval = null;
            }
            if (fireworksMusic) { // Stop fireworks music
              fireworksMusic.pause();
              fireworksMusic.currentTime = 0;
            }
          }
    });

    // Xử lý khi tab ẩn/hiện để dừng/khởi động lại việc tạo GIF pháo hoa
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // Tab bị ẩn, dừng việc tạo GIF pháo hoa mới
        // Loại bỏ dòng này để pháo hoa tiếp tục sinh ra khi tab bị ẩn
        // if (fireworkInterval) {
        //   clearInterval(fireworkInterval);
        //   fireworkInterval = null;
        // }
      } else {
        // Tab hiển thị trở lại, tiếp tục tạo GIF mới nếu màn hình thành công đang hiển thị
        if (successScreensaver && successScreensaver.style.display === 'block' && allowExitSuccessScreen) { // Thêm điều kiện cờ
          startFireworksEffect();
        }
      }
    });

    // Function to change background image
    function changeBackgroundImage() {
        if (wallpaperImageUrls.length === 0) {
            console.warn('No wallpaper images loaded.');
            return;
        }
        currentBackgroundIndex = (currentBackgroundIndex + 1) % wallpaperImageUrls.length;
        body.style.backgroundImage = `url(${wallpaperImageUrls[currentBackgroundIndex]})`;
    }

    // Function to start automatic background change
    function startBackgroundChange() {
        if (backgroundChangeInterval) {
            clearInterval(backgroundChangeInterval);
        }
        // Thay đổi ảnh nền ngay lập tức lần đầu
        changeBackgroundImage();
        // Sau đó thay đổi ảnh nền mỗi 5 giây (hoặc thời gian bạn muốn)
        backgroundChangeInterval = setInterval(changeBackgroundImage, 5000); // Change every 5 seconds
    }

    // New function to load wallpaper images from example.txt
    async function loadWallpaperImages() {
        try {
            console.log('Attempting to load wallpaper image URLs from wallpaper.txt...');
            // Tạo một timestamp để phá cache
            const timestamp = new Date().getTime();
            // Corrected URL for wallpaper.txt with cache busting
            const response = await fetch(`https://raw.githubusercontent.com/gnid31/meo/main/wallpaper.txt?t=${timestamp}`);
            if (!response.ok) {
                console.error(`Failed to fetch wallpaper.txt: HTTP error! status: ${response.status}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const text = await response.text();
            wallpaperImageUrls = text.split('\n').filter(url => url.trim() !== '');
            console.log('Successfully loaded wallpaper images. Count:', wallpaperImageUrls.length);
            console.log('Wallpaper URLs:', wallpaperImageUrls);
        } catch (error) {
            console.error('Error loading wallpaper images from wallpaper.txt:', error);
            // Fallback to a default image or show an error
            body.style.backgroundImage = `url("C:/Users/ADMIN/Desktop/meomeo/wallpaper/e82e59a091fccfe88d581ef7dc56f070.jpg")`; // Fallback to a default if loading fails
        }
    }

  </script>
  <div id="screensaver">
    <div id="exit-hint">Press any key to exit (trừ nút Space)</div>
    <img id="bouncing-image" src="" alt="Bouncing" />
  </div>



</body>

</html>